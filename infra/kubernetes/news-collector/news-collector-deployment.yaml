# ServiceAccount for Data Collector
apiVersion: v1
kind: ServiceAccount
metadata:
  name: news-data-collector-sa
  namespace: news-collector
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::236528210774:role/news-service-dev-news-data-collector
---
# PodDisruptionBudget for Data Collector
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: news-data-collector-pdb
  namespace: news-collector
spec:
  minAvailable: 1         # ìµœì†Œ 1ê°œ PodëŠ” í•­ìƒ ìœ ì§€
  selector:
    matchLabels:
      app: news-data-collector

---
# Deployment for Data Collector
apiVersion: apps/v1
kind: Deployment
metadata:
  name: news-data-collector
  namespace: news-collector
  labels:
    app: news-data-collector
spec:
  replicas: 1                            # ê³ ì • 1ê°œ (ì¤‘ë³µ ìˆ˜ì§‘ ë°©ì§€)
  strategy:
    type: Recreate                       # ê¸°ì¡´ Pod ì™„ì „ ì¢…ë£Œ â†’ ìƒˆ Pod ìƒì„±
  selector:
    matchLabels:
      app: news-data-collector
  template:
    metadata:
      labels:
        app: news-data-collector
    spec:
      tolerations:
      - key: "workload-type"
        operator: "Equal"
        value: application
        effect: NoSchedule
      nodeSelector:
        workload-type: application
      serviceAccountName: news-data-collector-sa
      containers:
      - name: data-collector
        image: 236528210774.dkr.ecr.ap-northeast-2.amazonaws.com/news-service/dev/news-collector:v1.0.9  # ECR ì´ë¯¸ì§€ë¡œ ë³€ê²½
        ports:
        - containerPort: 8001
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: CONNECTION_POOL_SIZE
          value: "2"                    # DB ì—°ê²° í’€ í¬ê¸°
        - name: KEEP_ALIVE_TIMEOUT
          value: "300"                   # ì—°ê²° ìœ ì§€ ì‹œê°„ 5ë¶„
        # í—¬ìŠ¤ì²´í¬ ì„¤ì •
        livenessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 120       # FastAPI + DB ì—°ê²° ì™„ë£Œ ëŒ€ê¸°
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 90
          periodSeconds: 15
          timeoutSeconds: 10
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 30           # ìµœëŒ€ 5ë¶„ ëŒ€ê¸°
        # ë¦¬ì†ŒìŠ¤ ì„¤ì • - ì—°ê²° ìœ ì§€ + ì‘ì—… ì‹œ ë²„ìŠ¤íŠ¸ ê³ ë ¤
        resources:
          requests:
            cpu: 100m                    # ì—°ê²° ìœ ì§€ + ê²½ëŸ‰ API ì„œë²„
            memory: 256Mi                # DB ì—°ê²° í’€ + ìºì‹œ
          limits:
            cpu: 1000m                   
            memory: 1Gi                 
        # ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL

---

# Service for Data Collector (ë‚´ë¶€ í†µì‹ ìš©)
apiVersion: v1
kind: Service
metadata:
  name: news-data-collector-service
  namespace: news-collector
  labels:
    app: news-data-collector
spec:
  selector:
    app: news-data-collector
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 8001
  type: ClusterIP

---

# CronJob for Scheduled News Collection
apiVersion: batch/v1
kind: CronJob
metadata:
  name: scheduled-news-collection
  namespace: news-collector
spec:
  schedule: "*/10 * * * *"              # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰
  concurrencyPolicy: Forbid             # ì´ì „ Job ë¯¸ì™„ë£Œ ì‹œ ìƒˆ Job ìƒì„± ì•ˆ í•¨
  startingDeadlineSeconds: 300          # 5ë¶„ ë‚´ ì‹œì‘ ëª»í•˜ë©´ ìŠ¤í‚µ
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      activeDeadlineSeconds: 600        # 10ë¶„ íƒ€ì„ì•„ì›ƒ
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: scheduled-trigger
            image: curlimages/curl:latest
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "ğŸ• ì •ê¸° ìˆ˜ì§‘ ì‹œì‘: $(date)"
              echo "ğŸ“ ì‹¤í–‰ ë…¸ë“œ: $NODE_NAME"
              echo "ğŸ“¦ íŒŒë“œëª…: $POD_NAME"
              
              # ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬
              echo "ğŸ” ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì¤‘..."
              if ! curl -f -s --connect-timeout 10 http://news-data-collector-service/health; then
                echo "âŒ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                exit 1
              fi
              echo "âœ… ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ í†µê³¼"
              
              # ì¤‘ë³µ ì‹¤í–‰ ì²´í¬ (ì„ íƒì )
              echo "ğŸ”„ ë°ì´í„° ìˆ˜ì§‘ API í˜¸ì¶œ ì¤‘..."
              RESPONSE=$(curl -sS -X POST -w "\n%{http_code}" http://news-data-collector-service/api/collect)
              
              HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              
              echo "ğŸ“Š HTTP Status: $HTTP_STATUS"
              echo "ğŸ“ Response: $BODY"
              echo "â° ì™„ë£Œ ì‹œê°„: $(date)"
              
              if [ "$HTTP_STATUS" = "200" ]; then
                echo "âœ… ì •ê¸° ìˆ˜ì§‘ ì™„ë£Œ"
              else
                echo "âŒ ì •ê¸° ìˆ˜ì§‘ ì‹¤íŒ¨"
                exit 1
              fi
            # í™˜ê²½ë³€ìˆ˜
            env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            # ë¦¬ì†ŒìŠ¤ ì œí•œ
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 100m
                memory: 128Mi
      backoffLimit: 2                   # ì¬ì‹œë„ íšŸìˆ˜